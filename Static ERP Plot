library(readr)
library(ggplot2)
library(ggiraph)
library(htmlwidgets)
library(dplyr)

# --- Load the smooth dataset ---
df <- read_csv("C:/Users/erees/OneDrive/Documents/649/DrivingEEG_GrandAvg_BOTH.csv", show_col_types = FALSE)

# --- Filter data to -200 to 800 ms range and aggregate ---
df_filtered <- df %>%
  filter(Time_ms >= -200 & Time_ms <= 800) %>%
  group_by(Channel, Condition, Time_ms) %>%
  summarise(GrandVoltage = mean(GrandVoltage, na.rm = TRUE), .groups = "drop")

# --- Create interactive line plot for each Channel separately ---
# Get unique channels
channels <- unique(df_filtered$Channel)

# Function to create plot for each channel
create_channel_plot <- function(channel_name) {
  
  df_channel <- df_filtered %>%
    filter(Channel == channel_name)
  
  p <- ggplot(
    df_channel,
    aes(x = Time_ms,
        y = GrandVoltage,
        color = Condition,
        group = Condition)
  ) +
    # Interactive lines with tooltips
    geom_line_interactive(
      aes(
        tooltip = paste0(
          "Channel: ", channel_name, "\n",
          "Condition: ", Condition, "\n",
          "Time (ms): ", Time_ms, "\n",
          "Amplitude (ÂµV): ", sprintf("%.2f", GrandVoltage)
        ),
        data_id = paste(Condition, Time_ms)
      ),
      linewidth = 1.5
    ) +
    
    # Add interactive points for better hover detection
    geom_point_interactive(
      aes(
        tooltip = paste0(
          "Channel: ", channel_name, "\n",
          "Condition: ", Condition, "\n",
          "Time (ms): ", Time_ms, "\n",
          "Voltage: ", sprintf("%.2f", GrandVoltage)
        ),
        data_id = paste(Condition, Time_ms)
      ),
      size = 2,
      alpha = 0.7
    ) +

    
    # Labels and theme
    labs(
      title = paste("ERP Waveform - Channel:", channel_name),
      subtitle = "Hover over points to see values | Drag to zoom | Double-click to reset",
      x = "Time relative to event (ms)",
      y = expression("Voltage")
    ) +
    scale_x_continuous(breaks = seq(-200, 800, 100)) +
    scale_color_manual(
      values = c("Motion" = "#0072B2", "Nonmotion" = "#D55E00"),
      labels = c("Motion", "Nonmotion")
    ) +
    theme_classic(base_size = 14) +
    theme(
      plot.title    = element_text(hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 10, color = "gray40"),
      legend.title  = element_blank(),
      legend.position = "top",
      axis.line     = element_line(color = "black"),
      axis.ticks    = element_line(color = "black"),
      axis.text     = element_text(color = "black"),
      panel.grid.major = element_line(color = "gray90", linewidth = 0.3),
      panel.grid.minor = element_blank()
    )
  
  # --- Create interactive version with zoom ---
  interactive_plot <- girafe(
    ggobj = p,
    width_svg = 12,
    height_svg = 7,
    options = list(
      opts_hover(css = "stroke-width:4;stroke:#FF5733;"),
      opts_zoom(min = 0.5, max = 4),
      opts_sizing(rescale = TRUE, width = 1),
      opts_toolbar(saveaspng = TRUE)
    )
  )
  
  return(interactive_plot)
}

# --- Create plots for each channel ---
#for (channel in channels) {
 # cat("\n--- Channel:", channel, "---\n")
  #plot_obj <- create_channel_plot(channel)
  #print(plot_obj)
#}

# Or for a single channel:
 plot_single <- create_channel_plot("C3")
 print(plot_single)
